<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Check-in HUB</title>
<style>
  :root{
    --bg:#f9f6f2; --title:#a64b2a; --btn:#a64b2a; --btn-hover:#8d3f23; --text:#5c3b2e; --border:#d18460;
  }
  body{
    margin:0; font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text); display:flex; align-items:center; justify-content:center; min-height:100vh;
  }
  .box{ text-align:center; }
  .logo{ width:160px; height:auto; display:block; margin:0 auto 10px; }
  h1{ color:var(--title); font-weight:700; margin:6px 0 16px; }
  .pin{ font-size:26px; margin-right:6px; vertical-align:middle; }
  input{
    border:1.5px solid var(--border); border-radius:8px; padding:10px 12px; width:260px; font-size:15px; outline:none;
    background:#fff; color:#333;
  }
  button{
    display:inline-block; margin-top:12px; background:var(--btn); color:#fff; border:none; border-radius:10px;
    padding:10px 18px; font-size:15px; cursor:pointer;
  }
  button:hover{ background:var(--btn-hover); }
  #status{ margin-top:12px; font-size:14px; }
  .ok{ color:#1b7031; font-weight:600; }
  .err{ color:#b62828; font-weight:600; }
</style>
</head>
<body>
  <div class="box">
    <img src="./mascote.png" alt="Mascote" class="logo"/>
    <h1><span class="pin">üìç</span>Check-in HUB</h1>
    <input id="idInput" placeholder="ID do motorista"/>
    <br/>
    <button id="btn">Registrar</button>
    <div id="status"></div>
  </div>

<script>
const API_URL = '/api/checkin'; 

(function init(){
  const params = new URLSearchParams(location.search);
  const prefillId = params.get('id') || '';
  if(prefillId) document.getElementById('idInput').value = prefillId;
  document.getElementById('btn').addEventListener('click', submit);
})();

function submit(){
  const id = document.getElementById('idInput').value.trim();
  const out = document.getElementById('status');
  const btn = document.getElementById('btn');

  if(!id){ out.innerHTML = '<div class="err">Informe seu ID.</div>'; return; }

  btn.disabled = true; btn.textContent = 'Obtendo localiza√ß√£o...';

  if(!navigator.geolocation){
    out.innerHTML = '<div class="err">Seu dispositivo n√£o suporta GPS.</div>';
    btn.disabled = false; btn.textContent = 'Registrar'; return;
  }

  navigator.geolocation.getCurrentPosition(success, fail, {enableHighAccuracy:true, timeout:12000, maximumAge:0});

  async function success(pos){
    const { latitude, longitude, accuracy } = pos.coords;
    const deviceId = getDeviceId();
    const ua = navigator.userAgent;
    btn.textContent = 'Registrando...';

    try{
      const r = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, lat: latitude, lng: longitude, acc: accuracy, deviceId, ua })
      });
      const resp = await r.json();
      out.innerHTML = resp.ok ? `<div class="ok">${resp.msg}</div>` : `<div class="err">${resp.msg}</div>`;
    }catch(e){
      out.innerHTML = `<div class="err">${e.message || e}</div>`;
    }finally{
      btn.disabled = false; btn.textContent = 'Registrar';
    }
  }

  function fail(){
    btn.disabled = false; btn.textContent = 'Registrar';
    out.innerHTML = '<div class="err">Ative o GPS e permita a localiza√ß√£o.</div>';
  }
}

function getDeviceId(){
  let id = localStorage.getItem('device_id');
  if(!id){
    id = 'DEV-' + Math.random().toString(36).slice(2,10) + '-' + Date.now().toString(36);
    localStorage.setItem('device_id', id);
  }
  return id;
}
</script>
</body>
</html>
