<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Drivers â€” Shopee</title>
  <style>
    :root{
      --bg:#fff9f5; --card:#ffe8d9; --card-2:#fff3ea; --text:#5a3a2f;
      --text-soft:#7d6158; --border:#f2cdb7; --accent:#ff8a4c; --accent-2:#fbd2bd;
      --muted:#9e8e88; --check:#f7fff6;
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .header h1{margin:0 0 6px;font-size:26px}
    .sub{color:var(--text-soft);font-size:14px}
    .card{background:linear-gradient(180deg,var(--card) 0,var(--card-2) 100%);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:14px}
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
    .pill{background:#fff;border:1px solid var(--border);border-radius:999px;padding:10px 12px;display:flex;gap:10px;align-items:center;flex:1 1 480px}
    .pill input{width:100%;border:none;outline:none;font-size:16px;background:transparent;color:var(--text)}
    .meta{margin-left:auto;color:var(--text-soft);font-size:12px}
    .err{margin:8px 0;padding:10px 12px;border-radius:12px;background:#fff1f0;color:#9c2f2f;border:1px solid #ffd3cf;display:none}
    .table-wrap{overflow:auto;border-radius:12px;border:1px solid var(--border);background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{text-align:left;font-size:13px;color:#6b4b42;letter-spacing:.02em;background:#ffe1cd;position:sticky;top:0;z-index:1;padding:10px 12px;border-bottom:1px solid var(--border)}
    tbody td{padding:10px 12px;border-bottom:1px solid #f5e3d9;font-size:14px}
    tbody tr:nth-child(even){background:#fffdfa}
    .hit{background:var(--check)}
    .badge{display:inline-block;min-width:28px;text-align:center;font-weight:700;background:var(--accent-2);color:#7a4a38;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:13px}
    .muted{color:var(--muted)}
    .highlight{outline:2px solid #ffb089;transition:outline-color .6s}
    .footer{display:flex;justify-content:space-between;align-items:center;color:var(--text-soft);font-size:12px;margin-top:10px;gap:12px;flex-wrap:wrap}
    @media (max-width:680px){.pill{flex:1 1 100%}.meta{width:100%;margin-left:0}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>ðŸ“‹ Painel de Drivers â€” Shopee</h1>
      <div class="sub">Ordenado por <strong>Corridor/Cage</strong> (Aâ†’Z). A coluna <strong>Ordem</strong> mostra a sequÃªncia de chegada por corredor.</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <label class="pill" title="Consultar posiÃ§Ã£o: digite seu ID (somente nÃºmeros)">
          <span class="muted">Consultar posiÃ§Ã£o:</span>
          <input id="q" inputmode="numeric" pattern="[0-9]*" placeholder="Digite seu Driver ID (ex.: 1450869)" />
        </label>
        <div id="last" class="meta">â€”</div>
      </div>

      <div id="err" class="err"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:140px">Driver ID</th>
              <th>Driver</th>
              <th style="width:160px">Corridor/Cage</th>
              <th style="width:110px">Ordem</th>
            </tr>
          </thead>
          <tbody id="tb"></tbody>
        </table>
      </div>

    <div class="footer">
  <div>
    Projeto <strong>Check-in</strong> â€¢ 
    Supervisora <strong>Cinthia Saraia</strong> â€¢ 
    Analista de Frota <strong>Ivan Adaulto</strong> â€¢ 
    Desenvolvedora <strong>Elane Nascimento MagalhÃ£es</strong>
  </div>
  <div id="count" class="muted">â€”</div>
</div>


  <script>
    // ===== Config do polling =====
    const API_URL = '/api/drivers-with-check';        // mesma origem
    const SERVER_TTL_MS = 20_000;                     // TTL da funÃ§Ã£o (anti-martelo)
    const BASE_POLL_MS  = 25_000;                     // base do polling
    const JITTER_MS_MIN = 3_000, JITTER_MS_MAX = 8_000;

    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const tb = $('#tb'), errBox = $('#err'), last = $('#last'), count = $('#count'), q = $('#q');

    function jitter(min, max){ return Math.floor(min + Math.random()*(max-min)); }
    function fmtNow(){ const d=new Date(); return d.toLocaleString('pt-BR',{hour12:false}); }
    function showErr(msg){ errBox.textContent='Erro: '+msg; errBox.style.display='block'; }
    function clearErr(){ errBox.style.display='none'; errBox.textContent=''; }
    const normId = s => String(s||'').replace(/\D+/g,'');

    // ===== Estado/caches =====
    let inFlight = false;
    let backoff = 0;               // 0 -> normal; >0 -> ms atÃ© prÃ³xima tentativa
    let lastData = null;
    let mapRowById = new Map();    // id -> <tr>

    // First Paint a partir do sessionStorage (stale-while-revalidate)
    try{
      const s = sessionStorage.getItem('panel-cache');
      if(s){ lastData = JSON.parse(s); }
    }catch(_){}

    function render(rows){
      tb.innerHTML = '';
      mapRowById = new Map();
      let total=0, comCheck=0;
      for(const r of rows){
        total++; if(r.hasCheck) comCheck++;
        const tr = document.createElement('tr');
        if(r.hasCheck) tr.classList.add('hit');

        const tdId=document.createElement('td');
        const tdNm=document.createElement('td');
        const tdCo=document.createElement('td');
        const tdOr=document.createElement('td');

        tdId.textContent = r.id || '';
        tdNm.textContent = r.name || '';
        tdCo.textContent = r.corridor || '';
        tdOr.innerHTML = r.ordem != null ? `<span class="badge">${r.ordem}</span>` : 'â€”';

        tr.dataset.driverId = normId(r.id);
        tr.appendChild(tdId); tr.appendChild(tdNm); tr.appendChild(tdCo); tr.appendChild(tdOr);
        tb.appendChild(tr);

        mapRowById.set(normId(r.id), tr);
      }
      count.textContent = `Linhas: ${total}` + (total?` â€¢ Com check-in: ${comCheck}`:'');
      last.textContent = 'Ãšltima atualizaÃ§Ã£o: ' + fmtNow();
    }

    async function fetchData(){
      if(inFlight) return; // coalesÃ§Ã£o
      inFlight = true;
      try{
        const res = await fetch(API_URL+'?debug=1',{cache:'no-store',keepalive:true});
        if(!res.ok){ throw new Error('API status '+res.status); }
        const j = await res.json();
        if(!j.ok){ throw new Error(j.error || 'Resposta invÃ¡lida'); }
        lastData = j.data || [];
        // cache leve para FP rÃ¡pido
        try{ sessionStorage.setItem('panel-cache', JSON.stringify(lastData)); }catch(_){}
        clearErr();
        render(lastData);
        backoff = 0; // reset backoff ao sucesso
        if(q.value) { highlightId(q.value); } // re-aplica destaque apÃ³s refresh
      }catch(e){
        showErr(String(e.message || e));
        // backoff exponencial simples: 10s, 20s, 40s (limite 60s)
        backoff = Math.min(backoff ? backoff*2 : 10_000, 60_000);
      }finally{
        inFlight = false;
      }
    }

    function scheduleNext(){
      const base = BASE_POLL_MS + jitter(JITTER_MS_MIN,JITTER_MS_MAX);
      const delay = backoff || base;
      setTimeout(loop, delay);
    }

    async function loop(){
      // respeita TTL do servidor (evita martelar)
      const now = Date.now();
      await fetchData();
      scheduleNext();
    }

    // Buscar e destacar por ID (a cada tecla, com debounce)
    let debounceTimer = null;
    function highlightId(raw){
      const id = normId(raw);
      if(!id || !mapRowById.has(id)) return;
      const row = mapRowById.get(id);
      row.classList.add('highlight');
      row.scrollIntoView({behavior:'smooth',block:'center'});
      setTimeout(()=>row.classList.remove('highlight'), 1200);
    }
    q.addEventListener('input', ()=>{
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>highlightId(q.value), 180);
    });

    // Inicial: pinta com cache se tiver, e comeÃ§a o loop
    if(Array.isArray(lastData) && lastData.length){
      render(lastData);
    }
    fetchData();     // primeira atualizaÃ§Ã£o imediata
    scheduleNext();  // segue no loop
  </script>
</body>
</html>
