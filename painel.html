<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Painel de Drivers ‚Äî Shopee</title>
<style>
  :root{
    --bg:#ffffff;
    --card:#fff7f2;
    --text:#3a2e29;
    --border:#f1d2be;
    --muted:#7b6b63;
    --orange:#e98a4a;
    --orange-dark:#d97a3e;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text); min-height:100vh; position:relative; overflow-x:hidden;
  }
  /* Marca d‚Äô√°gua Shopee */
  body::before{
    content:"Shopee";
    position:absolute; inset:0; display:block; text-align:center; top:45vh;
    font-size:120px; font-weight:800; color:rgba(233,138,74,0.06);
    transform:rotate(-18deg); pointer-events:none; user-select:none;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:36px 16px;position:relative;z-index:1}
  h1{margin:0 0 8px;color:var(--orange-dark);font-size:1.6rem}
  .small{color:var(--muted);font-size:.92rem}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:16px;
    padding:16px; margin-top:16px; box-shadow:0 8px 26px rgba(233,138,74,0.14);
  }
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .btn{
    background:var(--orange); color:#fff; border:none; border-radius:12px;
    padding:10px 16px; font-size:15px; cursor:pointer; box-shadow:0 6px 20px rgba(233,138,74,0.26);
    transition:.2s;
  }
  .btn:hover{ background:var(--orange-dark) }
  .btn:active{ transform:translateY(1px) }

  .search{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  input[type="text"]{
    border:1px solid var(--border); border-radius:10px; padding:10px 12px;
    background:#fff; color:#2c2c2c; min-width:240px; font-size:14px;
  }
  .info{
    font-size:.9rem; color:var(--orange-dark);
    background:#fff1e6; border:1px solid #ffd9ba; padding:8px 10px; border-radius:10px;
  }

  table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;border:1px solid #f3e0d2}
  thead th{
    position:sticky;top:0;background:#fff5ef;color:var(--orange-dark);
    padding:10px;border-bottom:2px solid var(--orange);text-align:left
  }
  tbody td{padding:10px;border-bottom:1px solid #f2e4d8}
  tbody tr:nth-child(even){background:#fffaf7}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
  .status{font-weight:600}
  .ok{background:#d1fae5;color:#065f46;padding:4px 8px;border-radius:999px}
  .decl{background:#fee2e2;color:#991b1b;padding:4px 8px;border-radius:999px}
  .dash{color:#999}
  .note{font-size:.86rem; color:var(--muted); margin-top:6px}

  /* destaque para linha encontrada */
  .hl{ animation: hlFlash 2.2s ease-out 1; }
  @keyframes hlFlash{
    0%{ background:#fff0e6; }
    50%{ background:#ffe3cc; }
    100%{ background:inherit; }
  }

  /* Assinatura de projeto (marca d‚Äô√°gua textual discreta) */
  .brand-watermark{
    position:fixed; left:14px; bottom:12px; font-size:11px; line-height:1.35;
    color:rgba(0,0,0,.25); user-select:none; pointer-events:none;
  }
  @media (prefers-color-scheme: dark) {
    .brand-watermark{ color:rgba(255,255,255,.25); }
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>üìã Painel de Drivers ‚Äî Shopee</h1>
    <p class="small">
      Ordenado por <strong>Corridor/Cage</strong> (A‚ÜíZ). A coluna <strong>Ordem</strong> mostra a posi√ß√£o geral (1¬∞, 2¬∞, ‚Ä¶).
    </p>

    <div class="card">
      <div class="row">
        <div class="search">
          <span class="small">Linhas: <span id="rowCount">0</span></span>
          <input id="q" type="text" placeholder="Consultar posi√ß√£o: digite seu ID (ex.: 1450869)"/>
          <span id="posInfo" class="info" style="display:none"></span>
        </div>
        <button id="btnReload" class="btn">Atualizar</button>
      </div>

      <div class="note">
        Status: üü¢ Check in quando registrou hoje; ap√≥s o hor√°rio-limite, quem n√£o registrou aparece como üõë Declinou.
      </div>

      <div style="overflow:auto;max-height:72vh;margin-top:10px">
        <table id="tbl">
          <thead>
            <tr>
              <th>Driver ID</th>
              <th>Driver</th>
              <th>Corridor/Cage</th>
              <th>Ordem</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Assinatura / marca d‚Äô√°gua de projeto -->
  <div class="brand-watermark">
    <strong>Projeto</strong><br>
    Supervisora: Cinthia Saiva<br>
    Analista de Frota: Ivan Adauto<br>
    Desenvolvedora: Elane Nascimento Magalh√£es<br>
    Since Out 2025
  </div>

<script>
/** =============================
 *  DADOS
 *  =============================
 *  Modo padr√£o: busca da API do seu app.
 *  Se quiser ‚Äú100% est√°tico‚Äù, comente o fetch e preencha STATIC_DATA.
 */
const API_URL = '/api/drivers-with-check';

// Exemplo para modo est√°tico (opcional):
// const STATIC_DATA = [
//   { id:'1450869', name:'ADOLFO DE OLIVEIRA FERREIRA', corridor:'H-22', inRef:true },
//   { id:'56280',   name:'JADSON SOUZA BONIFACIO',      corridor:'H-22', inRef:false },
// ];

let FULL_DATA = [];             // dados j√° ordenados
let DECLINE_TIME = {h:14,m:30}; // hor√°rio de "declined"
let lastHl;                     // √∫ltima TR destacada

function isAtOrAfterDecline(d = new Date(), thr = {h:14, m:30}){
  const nowM = d.getHours()*60 + d.getMinutes();
  return nowM >= (thr.h*60 + thr.m);
}

function render(rows, decline){
  const tbody   = document.querySelector('#tbl tbody');
  const counter = document.getElementById('rowCount');
  const showDeclined = isAtOrAfterDecline(new Date(), decline);
  tbody.innerHTML = '';

  // Ordena√ß√£o est√°tica em tela (corridor -> name)
  const sorted = rows.slice().sort((a,b)=>{
    return (a.corridor||'').localeCompare(b.corridor||'','pt-BR') ||
           (a.name||'').localeCompare(b.name||'','pt-BR');
  });

  const frag = document.createDocumentFragment();
  sorted.forEach((item, idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.id = String(item.id || '');

    const tdId  = document.createElement('td'); tdId.textContent  = item.id; tdId.className='mono';
    const tdNm  = document.createElement('td'); tdNm.textContent  = item.name;
    const tdCor = document.createElement('td'); tdCor.textContent = item.corridor || '';
    const tdOrd = document.createElement('td'); tdOrd.textContent = `${idx+1}¬∞`;

    const tdSt  = document.createElement('td'); tdSt.className='status';
    if(item.inRef) tdSt.innerHTML = '<span class="ok">üü¢ Check in</span>';
    else if(showDeclined) tdSt.innerHTML = '<span class="decl">üõë Declinou</span>';
    else tdSt.innerHTML = '<span class="dash">‚Äî</span>';

    tr.append(tdId, tdNm, tdCor, tdOrd, tdSt);
    frag.appendChild(tr);
  });

  tbody.appendChild(frag);
  counter.textContent = String(sorted.length);
  FULL_DATA = sorted;
}

async function load(){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';

  try{
    // ======= MODO DIN√ÇMICO (API) =======
    const r = await fetch(API_URL);
    const { ok, data = [], decline = {h:14,m:30}, msg } = await r.json();
    if(!ok) throw new Error(msg || 'Falha ao carregar');
    DECLINE_TIME = decline;
    render(data, DECLINE_TIME);

    // ======= MODO EST√ÅTICO (se quiser) =======
    // DECLINE_TIME = {h:14,m:30};
    // render(STATIC_DATA, DECLINE_TIME);

  }catch(e){
    tbody.innerHTML = `<tr><td colspan="5" class="decl">Erro: ${e.message}</td></tr>`;
  }
}

/** Busca instant√¢nea por ID:
 *  - conforme digita, se ID exato existir:
 *    ‚Ä¢ mostra nome, corredor e posi√ß√£o
 *    ‚Ä¢ destaca e rola at√© a linha
 */
function wireLiveSearch(){
  const input  = document.getElementById('q');
  const posInfo = document.getElementById('posInfo');

  input.addEventListener('input', e => {
    const raw = e.target.value.trim();
    if (!raw) {
      posInfo.style.display = 'none';
      if (lastHl) lastHl.classList.remove('hl');
      return;
    }

    const target = raw.toLowerCase();
    const idx = FULL_DATA.findIndex(d => String(d.id || '').toLowerCase() === target);

    if (idx === -1) {
      posInfo.textContent = `ID ${raw} n√£o encontrado.`;
      posInfo.style.display = 'inline-block';
      if (lastHl) lastHl.classList.remove('hl');
      return;
    }

    const pos = idx + 1;
    const driver = FULL_DATA[idx];
    posInfo.innerHTML = `
      <strong>${driver.name}</strong><br>
      ID: ${driver.id} ‚Ä¢ Corredor: ${driver.corridor || '-'}<br>
      üèÅ Posi√ß√£o: <strong>${pos}¬∞</strong> de ${FULL_DATA.length}
    `;
    posInfo.style.display = 'inline-block';

    const tbody = document.querySelector('#tbl tbody');
    const tr = tbody.querySelector(`tr[data-id="${CSS.escape(String(driver.id))}"]`);
    if (tr) {
      if (lastHl) lastHl.classList.remove('hl');
      tr.classList.add('hl');
      lastHl = tr;
      tr.scrollIntoView({ behavior:'smooth', block:'center' });
    }
  });
}

document.getElementById('btnReload')?.addEventListener('click', load);

// inicializa
load();
wireLiveSearch();
</script>
</body>
</html>
