<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Painel de Drivers â€” Shopee</title>
<style>
  :root{
    --bg:#ffffff;
    --card:#fff7f2;
    --text:#3a2e29;
    --border:#f1d2be;
    --muted:#7b6b63;
    --orange:#e98a4a;
    --orange-dark:#d97a3e;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text); min-height:100vh; position:relative; overflow-x:hidden;
  }
  /* Marca dâ€™Ã¡gua Shopee */
  body::before{
    content:"Shopee";
    position:absolute; inset:0; display:block; text-align:center; top:45vh;
    font-size:120px; font-weight:800; color:rgba(233,138,74,0.06);
    transform:rotate(-18deg); pointer-events:none; user-select:none;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:36px 16px;position:relative;z-index:1}
  h1{margin:0 0 8px;color:var(--orange-dark);font-size:1.6rem}
  .small{color:var(--muted);font-size:.92rem}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:16px;
    padding:16px; margin-top:16px; box-shadow:0 8px 26px rgba(233,138,74,0.14);
  }
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .btn{
    background:var(--orange); color:#fff; border:none; border-radius:12px;
    padding:10px 16px; font-size:15px; cursor:pointer; box-shadow:0 6px 20px rgba(233,138,74,0.26);
    transition:.2s;
  }
  .btn:hover{ background:var(--orange-dark) }
  .btn:active{ transform:translateY(1px) }
  .search{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }
  input[type="text"]{
    border:1px solid var(--border); border-radius:10px; padding:10px 12px;
    background:#fff; color:#2c2c2c; min-width:260px; font-size:14px;
  }
  table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;border:1px solid #f3e0d2}
  thead th{
    position:sticky;top:0;background:#fff5ef;color:var(--orange-dark);
    padding:10px;border-bottom:2px solid var(--orange);text-align:left
  }
  tbody td{padding:10px;border-bottom:1px solid #f2e4d8}
  tbody tr:nth-child(even){background:#fffaf7}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
  .status{font-weight:600}
  .ok{background:#d1fae5;color:#065f46;padding:4px 8px;border-radius:999px}
  .decl{background:#fee2e2;color:#991b1b;padding:4px 8px;border-radius:999px}
  .dash{color:#999}
  .note{font-size:.86rem; color:var(--muted); margin-top:6px}
  /* CrÃ©ditos/rodapÃ© minimalistas */
  .credits{
    margin-top:14px; font-size:.78rem; color:var(--muted);
    display:flex; gap:12px; flex-wrap:wrap
  }
  .credits b{color:var(--text)}
  mark{background:transparent;color:var(--orange-dark);font-weight:600}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ“‹ Painel de Drivers â€” Shopee</h1>
    <p class="small">
      Ordenado por <strong>Corridor/Cage</strong> (Aâ†’Z). A coluna <strong>Ordem</strong> mostra a posiÃ§Ã£o geral (1Â°, 2Â°, â€¦).
    </p>

    <div class="card">
      <div class="row">
        <div class="search">
          <span class="small">Linhas: <span id="rowCount">0</span></span>
          <input id="q" type="text" placeholder="Consultar posiÃ§Ã£o: digite seu ID (e.g. 1450869)"/>
        </div>
        <button id="btnReload" class="btn">Atualizar</button>
      </div>

      <div class="note">
        Status: <span class="ok" style="padding:2px 6px">ðŸŸ¢</span> Check in quando registrou hoje;
        apÃ³s o horÃ¡rio-limite, quem nÃ£o registrou aparece como
        <span class="decl" style="padding:2px 6px">ðŸ›‘</span> Declinou.
      </div>

      <div style="overflow:auto;max-height:72vh;margin-top:10px">
        <table id="tbl">
          <thead>
            <tr>
              <th>Driver ID</th>
              <th>Driver</th>
              <th>Corridor/Cage</th>
              <th>Ordem</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="credits">
        <span><b>Projeto</b> <mark>Check-in</mark></span>
        <span><b>Supervisora</b> Cinthia Saiva</span>
        <span><b>Analista de Frota</b> Ivan Adauto</span>
        <span><b>Desenvolvedor</b> Elane Nascimento Magalhaes</span>
        <span><b>Since</b> Out 2025</span>
      </div>
    </div>
  </div>

<script>
/* =======================
   CONFIG
======================= */
const API_URL = '/api/drivers-with-check'; // deve responder JSON { ok, data:[{id,name,corridor,inRef}], decline:{h,m} }
let FULL_DATA = [];
let DECLINE_CLOCK = { h:14, m:30 };

/* =======================
   HELPERS
======================= */
function isAtOrAfterDecline(d = new Date(), thr = {h:14, m:30}){
  const nowM = d.getHours()*60 + d.getMinutes();
  return nowM >= (thr.h*60 + thr.m);
}

function render(rows){
  const tbody = document.querySelector('#tbl tbody');
  const counter = document.getElementById('rowCount');
  const showDeclined = isAtOrAfterDecline(new Date(), DECLINE_CLOCK);
  tbody.innerHTML = '';

  // ordena por corredor e nome (painel estÃ¡tico)
  rows.sort((a,b)=>{
    return (a.corridor||'').localeCompare(b.corridor||'','pt-BR') ||
           (a.name||'').localeCompare(b.name||'','pt-BR');
  });

  const frag = document.createDocumentFragment();
  rows.forEach((item, idx)=>{
    const tr = document.createElement('tr');

    const tdId  = document.createElement('td'); tdId.textContent  = item.id; tdId.className='mono';
    const tdNm  = document.createElement('td'); tdNm.textContent  = item.name;
    const tdCor = document.createElement('td'); tdCor.textContent = item.corridor || '';
    const tdOrd = document.createElement('td'); tdOrd.textContent = `${idx+1}Â°`;

    const tdSt  = document.createElement('td'); tdSt.className='status';
    if(item.inRef) tdSt.innerHTML = '<span class="ok">ðŸŸ¢ Check in</span>';
    else if(showDeclined) tdSt.innerHTML = '<span class="decl">ðŸ›‘ Declinou</span>';
    else tdSt.innerHTML = '<span class="dash">â€”</span>';

    tr.append(tdId, tdNm, tdCor, tdOrd, tdSt);
    frag.appendChild(tr);
  });

  tbody.appendChild(frag);
  counter.textContent = String(rows.length);
}

/* =======================
   LOADING (resiliente)
======================= */
async function load(){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '<tr><td colspan="5">Carregandoâ€¦</td></tr>';

  try{
    const res = await fetch(API_URL, { cache: 'no-store' });
    const status = res.status;
    const ctype = (res.headers.get('content-type') || '').toLowerCase();

    // LÃª o corpo como texto SEMPRE
    const raw = await res.text();

    // Tenta converter em JSON com regras flexÃ­veis
    let payload;
    try{
      if (ctype.includes('application/json') || raw.trim().startsWith('{') || raw.trim().startsWith('[')) {
        payload = JSON.parse(raw);
      } else {
        throw new Error('Resposta nÃ£o-JSON');
      }
    } catch (parseErr){
      // Mostra erro legÃ­vel no grid
      const snippet = raw.slice(0, 240).replace(/\s+/g,' ').trim();
      tbody.innerHTML =
        `<tr><td colspan="5" class="decl">Erro: resposta invÃ¡lida do servidor (status ${status}).<br>`+
        `<small>ConteÃºdo recebido: <code>${escapeHtml(snippet) || '(vazio)'}</code></small></td></tr>`;
      return;
    }

    // Valida JSON esperado
    const { ok, data = [], decline = {h:14, m:30}, msg } = payload;
    if (!ok) {
      throw new Error(msg || `Falha de API (status ${status})`);
    }

    FULL_DATA = data.slice();
    DECLINE_CLOCK = decline || DECLINE_CLOCK;
    render(FULL_DATA);

  }catch(e){
    tbody.innerHTML = `<tr><td colspan="5" class="decl">Erro: ${escapeHtml(e.message)}</td></tr>`;
  }
}

function escapeHtml(s=''){
  return s.replace(/[&<>"'`]/g, c => (
    { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;', '`':'&#96;' }[c]
  ));
}

/* =======================
   BUSCA por ID/NOME/CORRIDOR
======================= */
const $q = document.getElementById('q');
let tId;
$q?.addEventListener('input', (ev)=>{
  const v = (ev.target.value || '').trim().toLowerCase();

  // debounce leve para experiÃªncia suave
  clearTimeout(tId);
  tId = setTimeout(()=>{
    if(!v){
      render(FULL_DATA);
      return;
    }
    const filtered = FULL_DATA.filter(item =>
      String(item.id||'').toLowerCase().includes(v) ||
      String(item.name||'').toLowerCase().includes(v) ||
      String(item.corridor||'').toLowerCase().includes(v)
    );
    render(filtered);
  }, 120);
});

document.getElementById('btnReload')?.addEventListener('click', load);
load();
</script>
</body>
</html>
