<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Painel de Drivers â€” Shopee</title>
<style>
  :root{
    --bg:#ffffff;
    --card:#fff7f2;
    --text:#3a2e29;
    --border:#f1d2be;
    --muted:#7b6b63;
    --orange:#e98a4a;
    --orange-dark:#d97a3e;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text); min-height:100vh; position:relative; overflow-x:hidden;
  }
  /* Marca dâ€™Ã¡gua Shopee */
  body::before{
    content:"Shopee";
    position:absolute; inset:0; display:block; text-align:center; top:45vh;
    font-size:120px; font-weight:800; color:rgba(233,138,74,0.06);
    transform:rotate(-18deg); pointer-events:none; user-select:none;
  }
  .wrap{max-width:1100px;margin:0 auto;padding:36px 16px;position:relative;z-index:1}
  h1{margin:0 0 8px;color:var(--orange-dark);font-size:1.6rem}
  .small{color:var(--muted);font-size:.92rem}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:16px;
    padding:16px; margin-top:16px; box-shadow:0 8px 26px rgba(233,138,74,0.14);
  }
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .btn{
    background:var(--orange); color:#fff; border:none; border-radius:12px;
    padding:10px 16px; font-size:15px; cursor:pointer; box-shadow:0 6px 20px rgba(233,138,74,0.26);
    transition:.2s;
  }
  .btn:hover{ background:var(--orange-dark) }
  .btn:active{ transform:translateY(1px) }
  .search{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }
  input[type="text"]{
    border:1px solid var(--border); border-radius:10px; padding:10px 12px;
    background:#fff; color:#2c2c2c; min-width:240px; font-size:14px;
  }
  table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;border:1px solid #f3e0d2}
  thead th{
    position:sticky;top:0;background:#fff5ef;color:var(--orange-dark);
    padding:10px;border-bottom:2px solid var(--orange);text-align:left
  }
  tbody td{padding:10px;border-bottom:1px solid #f2e4d8}
  tbody tr:nth-child(even){background:#fffaf7}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
  .status{font-weight:600}
  .ok{background:#d1fae5;color:#065f46;padding:4px 8px;border-radius:999px}
  .decl{background:#fee2e2;color:#991b1b;padding:4px 8px;border-radius:999px}
  .dash{color:#999}
  .note{font-size:.86rem; color:var(--muted); margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ“‹ Painel de Drivers â€” Shopee</h1>
    <p class="small">
      Ordenado por <strong>Corridor/Cage</strong> (Aâ†’Z). A coluna <strong>Ordem</strong> mostra a posiÃ§Ã£o geral (1Â°, 2Â°, â€¦).
    </p>

    <div class="card">
      <div class="row">
        <div class="search">
          <span class="small">Linhas: <span id="rowCount">0</span></span>
          <input id="q" type="text" placeholder="Filtrar por nome, ID ou corredor..."/>
        </div>
        <button id="btnReload" class="btn">Atualizar</button>
      </div>

      <div class="note">Status: ðŸŸ¢ Check in quando registrou hoje; apÃ³s o horÃ¡rio-limite, quem nÃ£o registrou aparece como ðŸ›‘ Declinou.</div>

      <div style="overflow:auto;max-height:72vh;margin-top:10px">
        <table id="tbl">
          <thead>
            <tr>
              <th>Driver ID</th>
              <th>Driver</th>
              <th>Corridor/Cage</th>
              <th>Ordem</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const API_URL = '/api/drivers-with-check'; // retorna { ok, data:[{id,name,corridor,inRef}], decline:{h,m} }
let FULL_DATA = [];

function isAtOrAfterDecline(d = new Date(), thr = {h:14, m:30}){
  const nowM = d.getHours()*60 + d.getMinutes();
  return nowM >= (thr.h*60 + thr.m);
}

function render(rows, decline){
  const tbody = document.querySelector('#tbl tbody');
  const counter = document.getElementById('rowCount');
  const showDeclined = isAtOrAfterDecline(new Date(), decline);
  tbody.innerHTML = '';

  // Ordena por corredor e nome
  rows.sort((a,b)=>{
    return (a.corridor||'').localeCompare(b.corridor||'','pt-BR') ||
           (a.name||'').localeCompare(b.name||'','pt-BR');
  });

  const frag = document.createDocumentFragment();
  rows.forEach((item, idx)=>{
    const tr = document.createElement('tr');

    const tdId  = document.createElement('td'); tdId.textContent  = item.id; tdId.className='mono';
    const tdNm  = document.createElement('td'); tdNm.textContent  = item.name;
    const tdCor = document.createElement('td'); tdCor.textContent = item.corridor || '';
    const tdOrd = document.createElement('td'); tdOrd.textContent = `${idx+1}Â°`;

    const tdSt  = document.createElement('td'); tdSt.className='status';
    if(item.inRef) tdSt.innerHTML = '<span class="ok">ðŸŸ¢ Check in</span>';
    else if(showDeclined) tdSt.innerHTML = '<span class="decl">ðŸ›‘ Declinou</span>';
    else tdSt.innerHTML = '<span class="dash">â€”</span>';

    tr.append(tdId, tdNm, tdCor, tdOrd, tdSt);
    frag.appendChild(tr);
  });

  tbody.appendChild(frag);
  counter.textContent = String(rows.length);
}

async function load(){
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';

  try{
    const r = await fetch(API_URL);
    const { ok, data = [], decline = {h:14,m:30}, msg } = await r.json();
    if(!ok) throw new Error(msg || 'Falha ao carregar');
    FULL_DATA = data.slice(); // guarda para filtros
    render(FULL_DATA, decline);
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="5" class="decl">Erro: ${e.message}</td></tr>`;
  }
}

// Filtro simples no cliente
document.getElementById('q')?.addEventListener('input', (ev)=>{
  const v = (ev.target.value || '').toLowerCase();
  const filtered = FULL_DATA.filter(item =>
    String(item.id||'').toLowerCase().includes(v) ||
    String(item.name||'').toLowerCase().includes(v) ||
    String(item.corridor||'').toLowerCase().includes(v)
  );
  render(filtered, {h:14,m:30});
});

document.getElementById('btnReload')?.addEventListener('click', load);
load();
</script>
</body>
</html>
