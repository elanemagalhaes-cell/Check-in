<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Drivers â€” Shopee</title>
  <style>
    :root{
      --bg:#fff9f5;
      --card:#ffe8d9;
      --card-2:#fff3ea;
      --text:#5a3a2f;
      --text-soft:#7d6158;
      --border:#f2cdb7;
      --accent:#ff8a4c;
      --accent-2:#fbd2bd;
      --success:#e7f7ed;
      --success-b:#2f7a43;
      --muted:#aaa;
      --check:#f7fff6;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .header h1{margin:0 0 6px;font-size:26px}
    .sub{color:var(--text-soft);font-size:14px}
    .card{
      background:linear-gradient(180deg,var(--card) 0,var(--card-2) 100%);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.06);
      padding:14px;
    }
    .toolbar{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 14px;
    }
    .pill{
      background:#fff; border:1px solid var(--border); border-radius:999px;
      padding:10px 12px; display:flex; gap:10px; align-items:center; flex:1 1 340px;
    }
    .pill input{
      width:100%; border:none; outline:none; font-size:14px; background:transparent; color:var(--text);
    }
    .btn{
      background:var(--accent); color:white; border:none; border-radius:12px;
      padding:10px 14px; font-weight:600; cursor:pointer; box-shadow:0 6px 14px rgba(255,138,76,.35);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .meta{margin-left:auto;color:var(--text-soft);font-size:12px}
    .err{
      margin:8px 0; padding:10px 12px; border-radius:12px;
      background:#fff1f0; color:#9c2f2f; border:1px solid #ffd3cf; display:none;
    }
    .table-wrap{overflow:auto; border-radius:12px; border:1px solid var(--border); background:#fff}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{
      text-align:left; font-size:13px; color:#6b4b42; letter-spacing:.02em;
      background:#ffe1cd; position:sticky; top:0; z-index:1; padding:10px 12px;
      border-bottom:1px solid var(--border);
    }
    tbody td{padding:10px 12px; border-bottom:1px solid #f5e3d9; font-size:14px}
    tbody tr:nth-child(even){background:#fffdfa}
    .hit{background:var(--check)}
    .badge{
      display:inline-block; min-width:28px; text-align:center; font-weight:700;
      background:var(--accent-2); color:#7a4a38; border:1px solid var(--border);
      border-radius:999px; padding:2px 8px; font-size:13px;
    }
    .muted{color:var(--muted)}
    .highlight{outline:2px solid #ffb089; transition:outline-color .6s}
    .footer{
      display:flex; justify-content:space-between; align-items:center; color:var(--text-soft);
      font-size:12px; margin-top:10px; gap:12px; flex-wrap:wrap;
    }
    @media (max-width:680px){
      .pill{flex:1 1 100%}
      .meta{width:100%; margin-left:0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>ðŸ“‹ Painel de Drivers â€” Shopee</h1>
      <div class="sub">Ordenado por <strong>Corridor/Cage</strong> (Aâ†’Z). A coluna <strong>Ordem</strong> mostra a sequÃªncia de chegada por corredor.</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <label class="pill" title="Consultar posiÃ§Ã£o: digite seu ID (somente nÃºmeros)">
          <span class="muted">Consultar posiÃ§Ã£o:</span>
          <input id="q" inputmode="numeric" pattern="[0-9]*" placeholder="Digite seu Driver ID (ex.: 1450869)" />
        </label>

        <button id="btnAtualizar" class="btn">Atualizar</button>

        <div id="last" class="meta">â€”</div>
      </div>

      <div id="err" class="err"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:140px">Driver ID</th>
              <th>Driver</th>
              <th style="width:160px">Corridor/Cage</th>
              <th style="width:110px">Ordem</th>
            </tr>
          </thead>
          <tbody id="tb">
            <!-- linhas renderizadas via JS -->
          </tbody>
        </table>
      </div>

      <div class="footer">
        <div>Projeto <strong>Check-in</strong> â€¢ Desenvolvido por <strong>Elane Nascimento MagalhÃ£es</strong></div>
        <div id="count" class="muted">â€”</div>
      </div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const tb = $('#tb');
    const errBox = $('#err');
    const last = $('#last');
    const count = $('#count');
    const q = $('#q');
    const btn = $('#btnAtualizar');

    function fmtNow(){
      const d = new Date();
      return d.toLocaleString('pt-BR', {hour12:false});
    }
    function showErr(msg){
      errBox.textContent = 'Erro: ' + msg;
      errBox.style.display = 'block';
    }
    function clearErr(){ errBox.style.display = 'none'; errBox.textContent=''; }

    function render(rows){
      tb.innerHTML = '';
      let total = 0, comCheck = 0;
      for(const r of rows){
        total++;
        if(r.hasCheck) comCheck++;

        const tr = document.createElement('tr');
        if(r.hasCheck) tr.classList.add('hit');

        const tdId = document.createElement('td');
        const tdNm = document.createElement('td');
        const tdCo = document.createElement('td');
        const tdOr = document.createElement('td');

        tdId.textContent = r.id || '';
        tdNm.textContent = r.name || '';
        tdCo.textContent = r.corridor || '';
        tdOr.innerHTML = r.ordem != null ? `<span class="badge">${r.ordem}</span>` : 'â€”';

        tr.dataset.driverId = (r.id || '').replace(/\D+/g,'');
        tr.appendChild(tdId); tr.appendChild(tdNm); tr.appendChild(tdCo); tr.appendChild(tdOr);
        tb.appendChild(tr);
      }
      count.textContent = `Linhas: ${total}` + (total ? ` â€¢ Com check-in: ${comCheck}` : '');
      last.textContent = 'Ãšltima atualizaÃ§Ã£o: ' + fmtNow();
    }

    async function carregar(){
      clearErr();
      btn.disabled = true;
      try{
        const res = await fetch('/api/drivers-with-check?debug=1',{cache:'no-store'});
        if(!res.ok){
          showErr(`Falha de API (status ${res.status})`);
          render([]);
          return;
        }
        const j = await res.json();
        if(!j.ok){
          showErr(j.error || 'Resposta invÃ¡lida da API');
          render([]);
          return;
        }
        if(!Array.isArray(j.data)){
          showErr('Formato inesperado da API');
          render([]);
          return;
        }
        render(j.data);
      }catch(e){
        showErr(String(e?.message || e));
        render([]);
      }finally{
        btn.disabled = false;
      }
    }

    // Busca por Driver ID e destaca
    function buscarPorId(id){
      id = String(id||'').replace(/\D+/g,'');
      if(!id){ return; }
      const row = tb.querySelector(`tr[data-driver-id="${id}"]`);
      if(!row){ return; }
      row.classList.add('highlight');
      row.scrollIntoView({behavior:'smooth', block:'center'});
      setTimeout(()=>row.classList.remove('highlight'), 1200);
    }

    // Eventos
    btn.addEventListener('click', carregar);
    q.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter'){
        buscarPorId(q.value);
      }
    });

    // Inicial
    carregar();
  </script>
</body>
</html>
