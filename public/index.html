<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Check-in HUB</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#fff;margin:0;display:flex;justify-content:center;min-height:100vh}
    .wrap{max-width:420px;width:100%;padding:24px}
    .card{border:1px solid #eee;border-radius:16px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    h1{font-size:26px;margin:8px 0 16px;display:flex;align-items:center;gap:10px}
    .pin{font-size:24px}
    input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #ddd;font-size:16px}
    button{margin-top:12px;width:100%;padding:12px 14px;border:0;border-radius:12px;background:#ff7a00;color:#fff;font-weight:700;font-size:16px;cursor:pointer}
    .small{color:#666;font-size:12px;margin-top:8px}
    .logo{display:block;margin:10px auto 16px;width:120px;height:120px;object-fit:contain}
    .msg{margin-top:10px;font-weight:600}
    .ok{color:#0a7c2e}
    .err{color:#b00020}
    .meta{font-size:12px;color:#555;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <img class="logo" src="assets/shopee-dog.png" alt="Shopee mascot" />
    <div class="card">
      <h1><span class="pin">üìç</span>Check-in HUB</h1>
      <label for="id">Driver ID</label>
      <input id="id" placeholder="ex: 449213" inputmode="numeric"/>
      <button id="btn">Registrar</button>
      <div class="small">
        Check-in v√°lido em at√© <b>1 km</b> de -22.798782, -43.348925. <a id="m1" href="#" target="_blank">Abrir mapa</a>
      </div>
      <div id="out" class="msg"></div>
      <div id="meta" class="meta"></div>
    </div>
  </div>
<script>
const api = "/api/checkin";
const toFixed = (n,p=5)=>Number(n).toFixed(p);

// deviceId persistente
function getDeviceId(){
  let id = localStorage.getItem("deviceId");
  if(!id){
    id = crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2)+"-"+Date.now();
    localStorage.setItem("deviceId", id);
  }
  return id;
}

// link de mapa
const LAT_BASE = -22.798782412241856;
const LNG_BASE = -43.3489248374091;
document.getElementById("m1").href = `https://www.google.com/maps?q=${LAT_BASE},${LNG_BASE}`;

async function getPosition(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("Geolocaliza√ß√£o indispon√≠vel"));
    navigator.geolocation.getCurrentPosition(
      (pos)=>resolve(pos),
      (err)=>reject(err),
      { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
    );
  });
}

async function doCheckin(){
  const out = document.getElementById("out");
  const meta = document.getElementById("meta");
  out.textContent = "Enviando..."; out.className="msg";
  meta.textContent = "";
  try{
    const id = document.getElementById("id").value.trim();
    const pos = await getPosition();
    const { latitude, longitude, accuracy } = pos.coords;
    const payload = {
      id,
      lat: latitude,
      lng: longitude,
      acc: accuracy,
      deviceId: getDeviceId(),
      ua: navigator.userAgent
    };
    const r = await fetch(api, {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    out.textContent = j.msg || (j.ok ? "OK" : "Erro");
    out.className = "msg " + (j.ok ? "ok" : "err");
    meta.textContent = `lat=${toFixed(payload.lat)}, lng=${toFixed(payload.lng)}, acc=${Math.round(payload.acc||0)}m`;
  }catch(e){
    out.textContent = "Falha ao obter localiza√ß√£o ou enviar dados.";
    out.className = "msg err";
  }
}

document.getElementById("btn").addEventListener("click", doCheckin);
</script>
</body>
</html>
